<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>Success</title>
</head>
<body>
<h2>로그인 완료</h2>

<p><button id="callMe">/api/me 호출</button></p>
<p><button id="clear">토큰 삭제</button></p>

<h3>LocalStorage</h3>
<pre id="storage"></pre>

<h3>Kakao Profile</h3>
<pre id="kakao"></pre>
<div>
    <p>Thumbnail:</p>
    <img id="thumbImg" style="max-width:120px;" />
</div>
<div>
    <p>Profile:</p>
    <img id="profileImg" style="max-width:240px;" />
</div>

<h3>/api/me 결과</h3>
<pre id="me"></pre>

<p><button id="kakaoLogout">카카오 로그아웃</button></p>

<script>
    const hash = location.hash ? location.hash.substring(1) : "";
    if (hash) {
      const hp = new URLSearchParams(hash);
      const accessToken = hp.get("accessToken");
      const role = hp.get("role");
      const nickname = hp.get("nickname");
      const thumbnailUrl = hp.get("thumbnailUrl");
      const profileUrl = hp.get("profileUrl");

      if (accessToken) localStorage.setItem("accessToken", accessToken);
      if (role) localStorage.setItem("role", role);

      // ✅ 카카오 프로필도 저장
      if (nickname) localStorage.setItem("nickname", nickname);
      if (thumbnailUrl) localStorage.setItem("thumbnailUrl", thumbnailUrl);
      if (profileUrl) localStorage.setItem("profileUrl", profileUrl);

      history.replaceState(null, "", location.pathname);
    }

    function clearLocal() {
      localStorage.removeItem("accessToken");
      localStorage.removeItem("role");
      localStorage.removeItem("signupTicket");
      localStorage.removeItem("nickname");
      localStorage.removeItem("thumbnailUrl");
      localStorage.removeItem("profileUrl");
    }

    function renderAll() {
      const token = localStorage.getItem("accessToken");
      const role = localStorage.getItem("role");

      const nickname = localStorage.getItem("nickname");
      const thumbnailUrl = localStorage.getItem("thumbnailUrl");
      const profileUrl = localStorage.getItem("profileUrl");

      document.getElementById("storage").innerText =
        JSON.stringify({ role, tokenPreview: token ? token.slice(0, 30) + "..." : null }, null, 2);

      document.getElementById("kakao").innerText =
        JSON.stringify({ nickname, thumbnailUrl, profileUrl }, null, 2);

      document.getElementById("thumbImg").src = thumbnailUrl || "";
      document.getElementById("profileImg").src = profileUrl || "";
    }
    renderAll();

    document.getElementById("callMe").addEventListener("click", async () => {
      const token = localStorage.getItem("accessToken");
      const res = await fetch("/api/me", {
        headers: { "Authorization": "Bearer " + token }
      });
      const text = await res.text();
      document.getElementById("me").innerText = text;
    });

    document.getElementById("clear").addEventListener("click", () => {
      clearLocal();
      renderAll();
    });

    document.getElementById("kakaoLogout").addEventListener("click", () => {
      clearLocal();
      location.href = "/auth/logout/kakao";
    });
</script>
</body>
</html>
